{% extends "layouts/base.html" %}
{% block page_content %}
<div class="section-page-container">
  <h1>{{ batch.course }} {{ batch.number }}</h1>
  <h2>Start Date: {{ batch.start_date }}</h2>
  <p>Total number of students: {{ batch.users.count }}</p>
  <div class="section-container">
    <div class="reassign-form">
    <h4>Reassign Sections</h4>
    <label>Students per section: </label>
    <form action="/student-admin/reassign-sections" method="POST">
      {% csrf_token %}
      <input type="text" name="number_per_section">
      <input type="hidden" name="batch_id" value="{{ batch.id }}">
      <button class="btn btn-primary" type="submit" value="Submit"  onclick="return confirm('Are you sure you would like to reassign sections?');"><i class="fas fa-sync-alt"></i></button>
    </form>
    </div>
    {% for section in sections %}
    <div class="section">
      <div class="section-header">
        <h3>Section: {{ section.number }}</h3>
        <button class="btn btn-primary copy-button" type="submit" value="{{ section.number }}">Copy email addresses</button>
        <button class="btn btn-primary copy-name-button" type="submit" value="{{ section.number }}">Copy Section Names</button>
      </div>
      <p>Number of students: {{ section.users|length }}</p>
      <table class="table table-striped">
        <thead>
          <tr>
            <th class="first-column" scope="col">Email</th>
            <th scope="col">First Name</th>
            <th scope="col">Last Name</th>
            <th scope="col">Switch Sections</th>
            <th scope="col">Delete from Section</th>
            <th scope="col">Delete from Batch</th>
          </tr>
        </thead>
        <tbody>
          {% for user in section.users %}
          <tr class="user-row-{{ section.number }}">
            <th class="user-email-{{ section.number }} first-column" scope="row">{{ user.email }}</th>
            <td class="user-fname-td">{{ user.first_name }}</td>
            <td class="user-lname-td">{{ user.last_name }}</td>
            <td>
              <form action="/student-admin/switch-sections" method="POST">
                {% csrf_token %}
                <select name="section_number" class="section-select">
                  <option selected="selected" disabled>--</option>
                  {% for dropdown_section in sections %}
                  {% if dropdown_section.id != section.id %}
                  <option value="{{ dropdown_section.id }}">{{ dropdown_section.number }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <input type="hidden" name="batch_id" value="{{ batch.id }}">
                <button class="btn btn-primary" type="submit" value="Submit"><i class="fas fa-sync-alt"></i></button>
              </form>
            </td>
            <td>
              <form action="/student-admin/delete-from-section" method="POST">
                {% csrf_token %}
                  <input type="hidden" name="section_id" value="{{ section.id }}">
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <input type="hidden" name="batch_id" value="{{ batch.id }}">
                <button class="btn btn-primary" type="submit"><i class="fas fa-trash-alt"></i></button>
              </form>
            </td>
            <td>
              <form action="/student-admin/delete-from-batch" method="POST">
                {% csrf_token %}
                <input type="hidden" name="section_id" value="{{ section.id }}">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <input type="hidden" name="batch_id" value="{{ batch.id }}">
                <button class="btn btn-primary" type="submit"><i class="fas fa-trash-alt"></i></button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
  </div>
  {% if users|length > 0 %}
  <h4>Students that don't belong in a section</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th class="first-column" scope="col">Email</th>
        <th scope="col">First Name</th>
        <th scope="col">Last Name</th>
        <th scope="col">Add to Section</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <th class="first-column" scope="row">{{ user.email }}</th>
        <td>{{ user.first_name }}</td>
        <td>{{ user.last_name }}</td>
        <td>
          <form action="/student-admin/add-to-section" method="POST">
            {% csrf_token %}
            <select name="section_id" class="section-select">
              <option selected="selected" disabled>--</option>
              {% for section in sections %}
              <option value="{{ section.id }}">{{ section.number }}</option>
              {% endfor %}
            </select>
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <input type="hidden" name="batch_id" value="{{ batch.id }}">
            <button class="btn btn-primary" type="submit" value="Submit"><i class="fas fa-user-plus"></i></button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  <script>
    const copyButtonArray = document.querySelectorAll('.copy-button');
    copyButtonArray.forEach(button => {
      button.addEventListener('click', () => {
        const data = [];
        const emails = document.querySelectorAll(`.user-email-${button.value}`);
        emails.forEach(email => {
          data.push(email.innerText);
        })
        copyToClipboard(data);
      })
    })

    const copyNameButtonArray = document.querySelectorAll('.copy-name-button');
    copyNameButtonArray.forEach(button => {
      button.addEventListener('click', () => {
        const userRow  = document.querySelectorAll(`.user-row-${button.value}`);
        const data = [...userRow].map(row => {
          let fname = row.querySelector(`.user-fname-td`).innerText;
          let lname = row.querySelector(`.user-lname-td`).innerText;
          fname = fname.toLowerCase()
          fname = fname.replace(/\b\w/g, l => l.toUpperCase())
          lname = lname.toLowerCase()
          lname = lname.replace(/\b\w/g, l => l.toUpperCase())
          return `${fname} ${lname}`;
        });

        copyToClipboard(data);
      })
    })

    const copyToClipboard = (data) => {
       // from stackoverflow, https://stackoverflow.com/questions/58376758/how-to-copy-a-json-data-to-the-clipboard-with-the-button
      let selBox = document.createElement('textarea');
      selBox.style.position = 'fixed';
      selBox.style.left = '0';
      selBox.style.top = '0';
      selBox.style.opacity = '0';
      selBox.value = data;
      document.body.appendChild(selBox);
      selBox.focus();
      selBox.select();
      document.execCommand('copy');
      document.body.removeChild(selBox);
    };
  </script>
</div>
{% endblock %}
